version: 0.2

phases:
  install:
    commands:
      # --- INSTALL: Install Terraform binary ---
      - echo "Installing Terraform v1.7.5..."
      
      - curl -o terraform.zip https://releases.hashicorp.com/terraform/1.7.5/terraform_1.7.5_linux_amd64.zip
      
      # Clean up and install the binary globally
      - rm -f /usr/local/bin/terraform # Remove existing if necessary
      - rm -rf terraform # Remove any temporary directory named 'terraform'
      - unzip -o terraform.zip
      - mv terraform /usr/local/bin/
      - rm terraform.zip # Clean up the downloaded zip file
      
      # Verify installation
      - terraform --version

  pre_build:
    commands:
      # --- PRE_BUILD: Initialize Terraform configuration ---
      - echo "Starting pre_build phase..."
      - ls -la
      
      - echo "Navigating to Terraform configuration directory (./terraform/)..."
      - cd terra/
      - ls -la
      
      # 2. FIX: Corrected the -backend-config command. 
      
      - echo "Initializing Terraform with S3 Backend Config..."
      - terraform init -backend-config="bucket=bucketname" -backend-config="key=backend/terraform.tfstate" -backend-config="region=ap-south-1"

  build:
    commands:
      # --- BUILD: Plan and Apply ---
      - echo "Running Terraform Plan..."
      
      - terraform plan -out=tfplan -input=false
      
      - echo "Running Terraform Apply..."
      # Apply the planned changes.
      - terraform apply -input=false tfplan

  post_build:
    commands:
      # --- POST_BUILD: Cleanup and verification ---
      - echo "Terraform deployment complete."
      - echo "Checking the state of the deployed infrastructure (optional, but useful)."
      - terraform state list

